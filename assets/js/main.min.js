(function(){const state={houses:Array.isArray(window.HOUSES)?window.HOUSES:[],wizards:Array.isArray(window.WIZARDS)?window.WIZARDS:[],showSpoilers:localStorage.getItem("hogwartsShowSpoilers")==="true"};document.addEventListener("DOMContentLoaded",init);function init(){setActiveNav();setupFooterYear();setupMobileNav();initSkipLinkFocus();const page=document.body.dataset.page||"";if(page==="home"){renderHome();}
const modal=createModal();if(page==="houses"){initHouses(modal);}
if(page==="wizards"){initWizards(modal);}
if(page==="timeline"){initTimeline();}
initSpoilerBanner();}
function setActiveNav(){const current=document.body.dataset.page;const links=document.querySelectorAll("[data-nav]");links.forEach((link)=>{if(link.dataset.nav===current){link.setAttribute("aria-current","page");}else{link.removeAttribute("aria-current");}});}
function setupFooterYear(){const yearEl=document.querySelectorAll("#footer-year");const year=new Date().getFullYear();yearEl.forEach((node)=>{node.textContent=String(year);});}
function setupMobileNav(){const toggle=document.querySelector(".nav-toggle");const nav=document.querySelector(".site-nav");if(!toggle||!nav)return;toggle.addEventListener("click",()=>{const isOpen=nav.classList.toggle("is-open");toggle.setAttribute("aria-expanded",String(isOpen));if(isOpen){nav.querySelector("a")?.focus();}});nav.addEventListener("click",(event)=>{if(event.target instanceof HTMLElement&&event.target.matches("a")){nav.classList.remove("is-open");toggle.setAttribute("aria-expanded","false");}});}
function initSkipLinkFocus(){const main=document.getElementById("main");if(!main)return;main.setAttribute("tabindex","-1");}
function createModal(){const modal=document.querySelector("[data-modal]");const backdrop=document.querySelector("[data-modal-overlay]");if(!modal||!backdrop){return{open:()=>{},close:()=>{},isOpen:()=>false};}
const dialog=modal.querySelector(".modal-dialog");const closeBtn=modal.querySelector("[data-modal-close]");const content=modal.querySelector("[data-modal-content]");const title=modal.querySelector("#modal-title");let lastFocus=null;const focusableSelector='a[href]:not([tabindex="-1"]), button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';function handleKeydown(event){if(event.key==="Escape"){event.preventDefault();close();return;}
if(event.key==="Tab"){const focusable=modal.querySelectorAll(focusableSelector);if(!focusable.length){event.preventDefault();return;}
const first=focusable[0];const last=focusable[focusable.length-1];if(event.shiftKey&&document.activeElement===first){event.preventDefault();last.focus();}else if(!event.shiftKey&&document.activeElement===last){event.preventDefault();first.focus();}}}
function open({titleText,bodyHtml,trigger}){if(!dialog||!content||!title)return;lastFocus=trigger instanceof HTMLElement?trigger:document.activeElement;title.textContent=titleText;content.innerHTML=bodyHtml;backdrop.hidden=false;modal.hidden=false;requestAnimationFrame(()=>{backdrop.classList.add("is-visible");modal.classList.add("is-visible");modal.setAttribute("aria-hidden","false");dialog.focus({preventScroll:true});document.addEventListener("keydown",handleKeydown);});}
function close(){backdrop.classList.remove("is-visible");modal.classList.remove("is-visible");modal.setAttribute("aria-hidden","true");document.removeEventListener("keydown",handleKeydown);setTimeout(()=>{backdrop.hidden=true;modal.hidden=true;if(lastFocus instanceof HTMLElement){lastFocus.focus();}},220);}
closeBtn?.addEventListener("click",close);backdrop.addEventListener("click",close);return{open,close,isOpen:()=>modal.classList.contains("is-visible")};}
function renderHome(){const houseTarget=document.getElementById("featured-house");const wizardTarget=document.getElementById("featured-wizard");if(state.houses.length&&houseTarget){const house=state.houses[Math.floor(Math.random()*state.houses.length)];houseTarget.innerHTML=`
        <figure class="featured-figure">
          <img src="${house.img}" alt="${house.name} house crest" loading="lazy" />
          <figcaption>
            <h3>${house.name}</h3>
            <p>${truncateText(house.summary, 180)}</p>
            <a class="btn btn-secondary" href="houses.html#${house.id}">View house dossier</a>
          </figcaption>
        </figure>
      `;}
if(state.wizards.length&&wizardTarget){const wizard=state.wizards[Math.floor(Math.random()*state.wizards.length)];const spoilerLevel=wizard.spoilerLevel||"low";wizardTarget.innerHTML=`
        <article class="featured-wizard" data-spoiler-level="${spoilerLevel}">
          <div class="featured-wizard-media">
            <img src="${wizard.img}" alt="Portrait of ${wizard.name}" loading="lazy" />
          </div>
          <div class="featured-wizard-body">
            <div class="badge">
              <span>${wizard.house}</span>
            </div>
            <h3>${wizard.name}</h3>
            <div class="card-summary" data-spoiler-level="${spoilerLevel}">
              <p class="summary-real">${truncateText(wizard.summary, 220)}</p>
              <p class="summary-placeholder">Spoiler hidden - toggle to view.</p>
            </div>
            <a class="btn btn-secondary" href="wizards.html#${wizard.id}">Read profile</a>
          </div>
        </article>
      `;updateSpoilerVisibility(wizardTarget);}}
function initHouses(modal){const grid=document.getElementById("house-grid");const emptyState=document.getElementById("house-empty");const searchInput=document.getElementById("house-search");const traitContainer=document.getElementById("trait-filters");if(!grid||!searchInput||!traitContainer)return;const traitSelections=new Set();const uniqueTraits=Array.from(new Set(state.houses.flatMap((house)=>house.traits||[]))).sort();traitContainer.innerHTML=uniqueTraits.map((trait,index)=>`
          <label class="checkbox" data-trait="${trait}">
            <input type="checkbox" value="${trait}" aria-describedby="trait-filter-label" />
            <span>${trait}</span>
          </label>
        `).join("");traitContainer.addEventListener("change",(event)=>{const target=event.target;if(!(target instanceof HTMLInputElement))return;const value=target.value;const label=target.closest(".checkbox");if(target.checked){traitSelections.add(value);label?.classList.add("active");}else{traitSelections.delete(value);label?.classList.remove("active");}
render(true);});searchInput.addEventListener("input",()=>render(true));grid.addEventListener("click",(event)=>{const trigger=event.target instanceof HTMLElement?event.target.closest("[data-action='view-house']"):null;if(!trigger)return;const id=trigger.getAttribute("data-id");const house=state.houses.find((item)=>item.id===id);if(!house)return;const modalMarkup=createHouseModalMarkup(house);modal.open({titleText:house.name,bodyHtml:modalMarkup,trigger});});let hashHandled=false;function render(skipHash){const term=searchInput.value.trim().toLowerCase();const selectedTraits=Array.from(traitSelections).map((trait)=>trait.toLowerCase());const filtered=state.houses.filter((house)=>{const matchesSearch=house.name.toLowerCase().includes(term);const matchesTraits=!selectedTraits.length||selectedTraits.every((trait)=>(house.traits||[]).some((houseTrait)=>houseTrait.toLowerCase()===trait));return matchesSearch&&matchesTraits;});grid.innerHTML=filtered.map((house)=>createHouseCardMarkup(house)).join("");emptyState&&(emptyState.hidden=filtered.length>0);if(!skipHash&&!hashHandled){hashHandled=attemptDeepLink(filtered,"house");}}
render(false);}
function createHouseCardMarkup(house){const excerpt=truncateText(house.summary,160);const colorsList=(house.colors||[]).map((color)=>`<li>${color}</li>`).join("");return`
      <article class="card" role="listitem" data-id="${house.id}">
        <img src="${house.img}" alt="${house.name} house crest" loading="lazy" />
        <header>
          <h3>${house.name}</h3>
          <p class="eyebrow">Founded by ${house.founder}</p>
        </header>
        <div class="card-body">
          <p>${excerpt}</p>
          <ul class="trait-list">${colorsList}</ul>
          <button class="btn btn-secondary" type="button" data-action="view-house" data-id="${house.id}">
            View details
          </button>
        </div>
      </article>
    `;}
function createHouseModalMarkup(house){const traitsList=(house.traits||[]).map((trait)=>`<li>${trait}</li>`).join("");const colorsList=(house.colors||[]).map((color)=>`<li>${color}</li>`).join("");return`
      <figure>
        <img src="${house.img}" alt="${house.name} house crest" loading="lazy" />
      </figure>
      <p>${house.summary}</p>
      <dl>
        <dt>Founder</dt><dd>${house.founder}</dd>
        <dt>Mascot</dt><dd>${house.mascot}</dd>
        <dt>House Ghost</dt><dd>${house.ghost}</dd>
        <dt>Relic</dt><dd>${house.relic}</dd>
      </dl>
      <h3>House Colors</h3>
      <ul class="trait-list">${colorsList}</ul>
      <h3>Defining Traits</h3>
      <ul class="trait-list">${traitsList}</ul>
    `;}
function initWizards(modal){const grid=document.getElementById("wizard-grid");const emptyState=document.getElementById("wizard-empty");const searchInput=document.getElementById("wizard-search");const houseFilters=document.getElementById("wizard-house-filters");const yearFilters=document.getElementById("wizard-year-filters");const spoilerToggle=document.getElementById("spoiler-toggle");if(!grid||!searchInput||!houseFilters||!yearFilters||!spoilerToggle)return;const houseSelections=new Set();const yearSelections=new Set();const houseNames=Array.from(new Set(state.houses.map((house)=>house.name))).sort();const years=Array.from(new Set(state.wizards.flatMap((wizard)=>wizard.years||[]))).sort((a,b)=>a-b);houseFilters.innerHTML=houseNames.map((house)=>`
          <label class="checkbox" data-house="${house}">
            <input type="checkbox" value="${house}" aria-label="${house} house filter" />
            <span>${house}</span>
          </label>
        `).join("");yearFilters.innerHTML=years.map((year)=>`
          <label class="checkbox" data-year="${year}">
            <input type="checkbox" value="${year}" aria-label="School year ${year}" />
            <span>${year}</span>
          </label>
        `).join("");spoilerToggle.checked=state.showSpoilers;houseFilters.addEventListener("change",(event)=>{const target=event.target;if(!(target instanceof HTMLInputElement))return;const value=target.value;const label=target.closest(".checkbox");if(target.checked){houseSelections.add(value);label?.classList.add("active");}else{houseSelections.delete(value);label?.classList.remove("active");}
render(true);});yearFilters.addEventListener("change",(event)=>{const target=event.target;if(!(target instanceof HTMLInputElement))return;const value=Number(target.value);const label=target.closest(".checkbox");if(target.checked){yearSelections.add(value);label?.classList.add("active");}else{yearSelections.delete(value);label?.classList.remove("active");}
render(true);});searchInput.addEventListener("input",()=>render(true));spoilerToggle.addEventListener("change",()=>{state.showSpoilers=spoilerToggle.checked;localStorage.setItem("hogwartsShowSpoilers",String(state.showSpoilers));render(true);syncTimelineSpoilers();});grid.addEventListener("click",(event)=>{const trigger=event.target instanceof HTMLElement?event.target.closest("[data-action='view-wizard']"):null;if(!trigger)return;const id=trigger.getAttribute("data-id");const wizard=state.wizards.find((item)=>item.id===id);if(!wizard)return;const markup=createWizardModalMarkup(wizard);modal.open({titleText:wizard.name,bodyHtml:markup,trigger});updateSpoilerVisibility(modalElement(modal));});let hashHandled=false;function render(skipHash){const term=searchInput.value.trim().toLowerCase();const selectedHouses=Array.from(houseSelections);const selectedYears=Array.from(yearSelections);const filtered=state.wizards.filter((wizard)=>{const matchesSearch=wizard.name.toLowerCase().includes(term);const matchesHouse=!selectedHouses.length||selectedHouses.includes(wizard.house);const matchesYears=!selectedYears.length||selectedYears.some((year)=>(wizard.years||[]).includes(year));return matchesSearch&&matchesHouse&&matchesYears;});grid.innerHTML=filtered.map((wizard)=>createWizardCardMarkup(wizard)).join("");emptyState&&(emptyState.hidden=filtered.length>0);updateSpoilerVisibility(grid);if(!skipHash&&!hashHandled){hashHandled=attemptDeepLink(filtered,"wizard");}}
render(false);}
function modalElement(modal){return document.querySelector("[data-modal]");}
function createWizardCardMarkup(wizard){const house=state.houses.find((house)=>house.name===wizard.house);const badgeMedia=house?`<img src="${house.img}" alt="${house.name} crest" loading="lazy" />`:"";const years=(wizard.years||[]).map((year)=>`<li>${year}</li>`).join("");const spoilerLevel=wizard.spoilerLevel||"low";return`
      <article class="card" role="listitem" data-id="${wizard.id}">
        <img src="${wizard.img}" alt="Portrait of ${wizard.name}" loading="lazy" />
        <div class="card-body">
          <div class="badge">
            ${badgeMedia}
            <span>${wizard.house}</span>
          </div>
          <h3>${wizard.name}</h3>
          <div class="card-summary" data-spoiler-level="${spoilerLevel}">
            <p class="summary-real">${truncateText(wizard.summary, 180)}</p>
            <p class="summary-placeholder">Spoiler hidden - toggle to view.</p>
          </div>
          <ul class="years-badge-list">${years}</ul>
          <button class="btn btn-secondary" type="button" data-action="view-wizard" data-id="${wizard.id}">
            View details
          </button>
        </div>
      </article>
    `;}
function createWizardModalMarkup(wizard){const aliases=(wizard.aliases||[]).length?`<h3>Aliases</h3><ul class="detail-list">${wizard.aliases
          .map((alias) => `<li>${alias}</li>`)
          .join("")}</ul>`:"";const events=(wizard.notableEvents||[]).map((event)=>`<li>${event}</li>`).join("");const years=(wizard.years||[]).map((year)=>`<li>${year}</li>`).join("");return`
      <figure>
        <img src="${wizard.img}" alt="Portrait of ${wizard.name}" loading="lazy" />
      </figure>
      <div class="card-summary" data-spoiler-level="${wizard.spoilerLevel || "low"}">
        <p class="summary-real">${wizard.summary}</p>
        <p class="summary-placeholder">Spoiler hidden - toggle to view.</p>
      </div>
      ${aliases}
      <h3>Notable Events</h3>
      <ul class="events-list">${events}</ul>
      <h3>Years Active</h3>
      <ul class="years-badge-list">${years}</ul>
    `;}
function initTimeline(){const timeline=document.getElementById("timeline");const emptyState=document.getElementById("timeline-empty");if(!timeline)return;const eventsByYear=new Map();state.houses.forEach((house)=>{if(house.established){const year=Number(house.established);if(!eventsByYear.has(year)){eventsByYear.set(year,[]);}
eventsByYear.get(year).push({type:"house",id:house.id,title:`${house.name} House`,description:house.timelineHighlight||house.summary,summary:house.summary,house:house.name,spoilerLevel:"low"});}});state.wizards.forEach((wizard)=>{const summary=wizard.summary;const description=wizard.notableEvents?.join(", ")||"";const level=wizard.spoilerLevel||"low";(wizard.years||[]).forEach((year)=>{if(!eventsByYear.has(year)){eventsByYear.set(year,[]);}
eventsByYear.get(year).push({type:"wizard",id:wizard.id,title:wizard.name,description,summary,house:wizard.house,spoilerLevel:level});});});const years=Array.from(eventsByYear.keys()).sort((a,b)=>a-b);if(!years.length){emptyState&&(emptyState.hidden=false);return;}
emptyState&&(emptyState.hidden=true);timeline.innerHTML="";years.forEach((year)=>{const section=document.createElement("section");section.className="timeline-group";const heading=document.createElement("h3");heading.className="timeline-year";heading.textContent=String(year);section.appendChild(heading);const list=document.createElement("ol");list.className="timeline-items";const events=eventsByYear.get(year)||[];events.sort((a,b)=>a.title.localeCompare(b.title)).forEach((event)=>{const item=document.createElement("li");item.className="timeline-item";item.dataset.id=event.id;item.dataset.source=event.type;item.dataset.spoilerLevel=event.spoilerLevel;item.innerHTML=`
            <button class="timeline-toggle" type="button" aria-expanded="false">
              <span class="timeline-title">${event.title}</span>
              <span class="timeline-meta">${event.type === "house" ? "House milestone" : `${event.house}wizard`}</span>
            </button>
            <div class="timeline-panel" hidden>
              <div class="card-summary" data-spoiler-level="${event.spoilerLevel}">
                <p class="summary-real">${event.summary}</p>
                <p class="summary-placeholder">Spoiler hidden - toggle to view.</p>
              </div>
              <p>${event.description}</p>
              <a href="${event.type === "house" ? `houses.html#${event.id}` : `wizards.html#${event.id}`}" class="btn btn-tertiary">
                View full profile
              </a>
            </div>
          `;list.appendChild(item);});section.appendChild(list);timeline.appendChild(section);});updateSpoilerVisibility(timeline);timeline.addEventListener("click",(event)=>{const toggle=event.target instanceof HTMLElement?event.target.closest(".timeline-toggle"):null;if(!toggle)return;const item=toggle.closest(".timeline-item");const panel=item?.querySelector(".timeline-panel");if(!panel)return;const expanded=toggle.getAttribute("aria-expanded")==="true";toggle.setAttribute("aria-expanded",String(!expanded));panel.hidden=expanded;if(!expanded){updateSpoilerVisibility(panel);}});}
function attemptDeepLink(collection,type){if(!location.hash)return false;const id=decodeURIComponent(location.hash.slice(1));const item=collection.find((entry)=>entry.id===id);if(!item)return false;const button=document.querySelector(`[data-action='view-${type}'][data-id='${id}']`);if(button instanceof HTMLElement){button.focus({preventScroll:true});button.scrollIntoView({behavior:"smooth",block:"center"});button.click();return true;}
return false;}
function updateSpoilerVisibility(root=document){const showSpoilers=state.showSpoilers;const summaryNodes=root.querySelectorAll("[data-spoiler-level]");summaryNodes.forEach((node)=>{const level=node.getAttribute("data-spoiler-level")||"low";const visible=showSpoilers||level!=="high";node.setAttribute("data-spoiler-visible",visible?"true":"false");});}
function syncTimelineSpoilers(){const timeline=document.getElementById("timeline");if(timeline){updateSpoilerVisibility(timeline);}}
function initSpoilerBanner(){const banner=document.querySelector("[data-spoiler-banner]");if(!banner)return;const dismissed=localStorage.getItem("hogwartsSpoilerBannerDismissed")==="true";banner.hidden=dismissed;const dismissBtn=banner.querySelector("[data-banner-dismiss]");dismissBtn?.addEventListener("click",()=>{banner.hidden=true;localStorage.setItem("hogwartsSpoilerBannerDismissed","true");});}
function truncateText(text,limit){if(!text)return"";if(text.length<=limit)return text;return`${text.slice(0, limit - 1).trimEnd()}â€¦`;}})();